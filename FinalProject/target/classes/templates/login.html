<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>로그인</title>
<style>
	.error-message{
		display: block;
		color: red;
	}
</style>
</head>
<body>
	<div>
        <h2>Login</h2>
        <form id="loginForm" action="/login_proc" method="post">
         	<span id="errorMsg" class="error-message"></span>
            <div>
                <label for="email">Email: </label>
                <input type="text" name="email" id="email" placeholder="Email"/>
                <span id="emailError" class="error-message"></span>
                <!-- Thymeleaf의 Elvis 연산자 ?:란?  왼쪽 표현식이 null이 아니면 값 반환, null 이면 오른쪽 표현식의 값 반환 -->
                <!-- <input type="text" name="email" id=th:value="${email ?: ''}" placeholder="Email"/>  --> 
            </div>
            <div>
                <label for="password">Password: </label>
                <input type="password" name="password" id="password" placeholder="Password"/>
            	<span id="passwordError" class="error-message"></span>
            </div>
            <button type="submit" id="login">로그인(Longin)</button>
            <!-- 현재 페이지에서 다른 페이지로 이동 형식
            	 : onclick ="location.href='index.html'" -->
            <!-- \': 따옴표(')를 표현하는 이스케이프 문자 -->
		</form>
        <div>
            <button type="button" onclick="window.location.href='/signUp'">회원가입</button>
        </div>
    </div>
    
    <script type="text/javascript">
    // 로그인 버튼 클릭했을 때 
    document.getElementById('loginForm').addEventListener('submit', function(event) {
    	event.preventDefault();  // 폼 제출 중지(이벤트 발생할 때마다 해당 이벤트에서만 실행)

    	var emailError = document.getElementById('emailError');		// 이메일 에러 메시지
    	var passwordError = document.getElementById('passwordError');	// 비밀번호 에러 메시지
    
    	var email = document.getElementById('email');		// 이메일 
    	var password = document.getElementById('password');	// 비밀번호 
    	
    	// 이메일 입력이 없는 경우
		if(email.value === ""){
			emailError.textContent = '이메일 필수 입력';
		} else {
			// 이메일이 유효한 경우
			emailError.textContent = "";	// 에러 메시지 없애기
		}
    	
		// 비밀번호 입력이 없는 경우
		if(password.value === ""){
			passwordError.textContent = '비밀번호 필수 입력';
		} else {
			// 비밀번호가 유효한 경우
  			passwordError.textContent = "";	// 에러 메시지 없애기
		  }
		
		if((emailError.textContent === "") && (passwordError.textContent === "")){
			var xhr = new XMLHttpRequest();
	        xhr.open('POST', '/login_proc', true);
	     // Spring Security 기본 설정: application/x-www-form-urlencoded 형식의 데이터를 처리 = submit 타입과 같은 형식
	        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');	
	        
	        xhr.onload = function() {
	            if (xhr.status === 200) {
	            	// security는 서버에서 리다이렉트 수행
	            	// ajax를 이용한 비동기 방식으로 클라이언트 측에서 로그인 요청
	            	// 		=> 서버에서 리다이렉트 수행해도 클라이언트 측에서 인식 X
	            	// 		=> 클라이언트 측에서 별도로 리다이렉트 수행 필요
	            	// 일반적으로 서버에서 리다이렉트 수행 -> 브라우저가 인식해 해당 페이지로 이동 => 브라우저가 이를 자동으로 처리
	            	// 비동기 요청인 경우, 브라우저가 자동으로 리다이렉트 처리 X => 대신, 리다이렉트 응답이 JS에게 전달되고 JS코드에서 처리 과정 필요
	            	window.location.href='/home'
	            }else{
	            	var json = JSON.parse(xhr.responseText);
	                document.getElementById('errorMsg').textContent = json.errorMsg;
	            }
	        };
			
	        // application/x-www-form-urlencoded 형식의 데이터로 변환(URL인코딩 필요)
	        var data = 'email=' + encodeURIComponent(document.getElementById('email').value) + 
	        '&password=' + encodeURIComponent(document.getElementById('password').value);
	        
	        xhr.send(data);
		}
    });
    
	</script>
</body>
</html>